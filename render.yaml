# Base de datos PostgreSQL está en Railway, no en Render
# DATABASE_URL debe configurarse manualmente en Render con la External Database URL de Railway

services:
  - type: web
    name: motor-sentimientos
    env: python
    region: oregon
    plan: free
    buildCommand: |
      echo "=== Verificando versión de Python ==="
      python3 --version
      which python3
      echo "=== PWD ==="
      pwd
      echo "=== Verificando estructura ==="
      ls -la
      echo "=== Instalando Node.js ==="
      npm --version
      node --version
      echo "=== Instalando dependencias Node.js ==="
      npm install
      echo "=== Verificando app/static ==="
      mkdir -p app/static || echo "app/static ya existe"
      ls -la app/ || echo "app/ no existe"
      echo "=== Construyendo React ==="
      npm run build || echo "BUILD FALLÓ"
      echo "=== Verificando build ==="
      find . -name "dist" -type d 2>/dev/null || echo "No se encontró dist"
      ls -la app/static/ || echo "app/static no existe"
      ls -la app/static/dist/ 2>/dev/null || echo "app/static/dist no existe"
      echo "=== Verificando archivos generados ==="
      find app/static/dist -type f 2>/dev/null | head -20 || echo "No hay archivos en dist"
      echo "=== Instalando dependencias Python ==="
      python3 -m pip install --upgrade pip setuptools wheel
      python3 -m pip install -r requirements.txt
      echo "=== Ejecutando migraciones de base de datos ==="
      python3 -m alembic upgrade head || echo "Migraciones no ejecutadas (puede ser primera vez)"
    startCommand: python3 -m gunicorn -k uvicorn.workers.UvicornWorker app.main:app --bind 0.0.0.0:$PORT
    envVars:
      - key: PYTHON_VERSION
        value: "3.11"
      - key: NODE_VERSION
        value: 20
      - key: DATABASE_URL
        sync: false  # Configurar manualmente con la External Database URL de Railway
      - key: SECRET_KEY
        generateValue: true
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: FRONTEND_URL
        sync: false
      - key: STRIPE_PUBLIC_KEY
        sync: false
        optional: true
      - key: STRIPE_SECRET_KEY
        sync: false
        optional: true
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
        optional: true
      - key: GOOGLE_MAPS_API_KEY
        sync: false
        description: "API key de Google Maps (requiere habilitar: Geocoding API, Places API, Distance Matrix API, Directions API y Roads API)"

